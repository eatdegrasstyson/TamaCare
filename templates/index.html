<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TamaCare · Health Tamagotchi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Pixel font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #050816;
      --shell: #181826;
      --screen: #101421;
      --accent: #facc15;
      --accent-soft: #4ade80;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --border-dark: #000000;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background:
        repeating-linear-gradient(
          0deg,
          #020617,
          #020617 2px,
          #050816 2px,
          #050816 4px
        );
      color: var(--text-main);
      font-family: "Press Start 2P", system-ui, sans-serif;
      image-rendering: pixelated;
    }

    .crt {
      position: fixed;
      inset: 0;
      pointer-events: none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255, 255, 255, 0.03),
        rgba(255, 255, 255, 0.03) 1px,
        transparent 1px,
        transparent 3px
      );
      mix-blend-mode: screen;
      opacity: 0.6;
      z-index: 0;
    }

    .app {
      position: relative;
      width: 100%;
      max-width: 680px;
      background: var(--shell);
      padding: 12px;
      border-radius: 0;
      border: 4px solid var(--border-dark);
      box-shadow:
        0 0 0 4px #f4f4f5,
        0 0 0 8px #000,
        0 16px 0 0 #000;
      z-index: 1;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .title {
      font-size: 10px;
      color: var(--accent);
      text-shadow: 2px 2px 0 #000;
    }

    .subtitle {
      font-size: 7px;
      color: var(--text-muted);
      text-align: right;
    }

    .grid {
      display: grid;
      grid-template-columns: 210px 1fr;
      gap: 8px;
      margin-top: 6px;
    }

    .card {
      background: var(--screen);
      border-radius: 0;
      border: 3px solid #000;
      box-shadow: inset 0 0 0 2px #272744;
      padding: 8px;
    }

    /* PET SECTION */
    .pet-shell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .pet-screen {
      width: 140px;
      height: 120px;
      border: 4px solid #000;
      box-shadow:
        inset 0 0 0 3px #e5e7eb,
        0 4px 0 #000;
      background: #a0c58b;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      flex-direction: column;
      padding-top: 16px;
    }

    .pet-chicken {
    width: 384px;           /* adjust to your sprite size */
    height: 384px;
    image-rendering: pixelated;
    object-fit: contain;
    text-align: center;
    margin-bottom: 6px;
    margin-top: 64px;
    }

    .pet-chicken.streak {
    animation: streak-bounce 0.4s ease-in-out 4;
    }

    @keyframes streak-bounce {
    0% {
        transform: translateY(0) scale(1);
        filter: brightness(1);
    }
    50% {
        transform: translateY(-3px) scale(1.08);
        filter: brightness(1.3);
    }
    100% {
        transform: translateY(0) scale(1);
        filter: brightness(1);
    }
    }


    .pet-status-text {
      font-size: 7px;
      text-align: center;
      color: #000;
      padding: 1px 2px;
      background: rgba(0, 0, 0, 0.1);
    }

    .pet-caption {
      font-size: 7px;
      color: var(--text-muted);
      text-align: center;
    }

    .pet-bubble {
      position: absolute;
      top: -4px;
      left: 0px;
      max-width: 110px;
      background: #f4f4f5;
      color: #000;
      border: 3px solid #000;
      padding: 3px 4px;
      font-size: 7px;
      line-height: 1.3;
      box-shadow: 0 3px 0 #000;
    }

    .pet-bubble::after {
      content: "";
      position: absolute;
      bottom: -5px;
      left: 10px;
      width: 0;
      height: 0;
      border-width: 5px 4px 0 4px;
      border-style: solid;
      border-color: #000 transparent transparent transparent;
    }

    .pet-bubble-text {
      display: inline-block;
    }

    .stats {
      width: 100%;
      font-size: 7px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-top: 3px;
    }

    .bar-bg {
      margin-top: 2px;
      width: 100%;
      height: 8px;
      background: #020617;
      border: 2px solid #000;
      display: flex;
      align-items: center;
    }

    .bar-fill {
      height: 100%;
      width: 50%;
      transition: width 0.2s steps(3, end);
    }

    .bar-energy {
      background: #4ade80;
    }

    .bar-mood {
      background: #38bdf8;
    }

    /* NEW: health snapshot panel */
    .health-panel {
      margin-top: 6px;
      padding: 4px;
      border: 2px solid #000;
      background: #020617;
    }

    .health-title {
      font-size: 7px;
      margin-bottom: 3px;
      color: var(--accent-soft);
    }

    .health-row {
      display: flex;
      justify-content: space-between;
      font-size: 7px;
      margin-top: 2px;
    }

    .health-small {
      font-size: 6px;
      margin-top: 3px;
      color: var(--text-muted);
    }

    .health-sync-btn {
      margin-top: 5px;
      width: 100%;
      text-align: center;
      padding: 4px 0;
      font-size: 7px;
      border: 2px solid #000;
      background: #4ade80;
      color: #022c22;
      cursor: pointer;
      box-shadow: 0 3px 0 #000;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
    }

    .health-sync-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 0 #000;
    }

    /* CHAT SECTION */

    .chat-log {
      height: 220px;
      overflow-y: auto;
      padding-right: 2px;
      font-size: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 6px;
    }

    .msg {
      max-width: 96%;
      padding: 4px 4px;
      border-radius: 0;
      line-height: 1.4;
      border: 2px solid #000;
      background: #0b1020;
    }

    .msg-user {
      align-self: flex-end;
      background: #1d4ed8;
      color: #e5e7eb;
    }

    .msg-pet {
      align-self: flex-start;
      background: #020617;
      color: #f9fafb;
    }

    .chat-input-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    textarea {
      width: 100%;
      min-height: 60px;
      resize: vertical;
      border-radius: 0;
      border: 3px solid #000;
      background: #020617;
      color: var(--text-main);
      font-family: "Press Start 2P", system-ui, sans-serif;
      font-size: 8px;
      padding: 4px;
      outline: none;
    }

    textarea::placeholder {
      color: #6b7280;
    }

    .buttons-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .btn {
      border: 3px solid #000;
      border-radius: 0;
      padding: 6px 8px;
      font-size: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 0 #000;
      font-family: "Press Start 2P", system-ui, sans-serif;
      text-transform: uppercase;
    }

    .btn:active {
      transform: translateY(2px);
      box-shadow: 0 2px 0 #000;
    }

    .btn-send {
      background: #38bdf8;
      color: #0f172a;
      flex: 1;
    }

    .btn-habit {
      background: #4ade80;
      color: #022c22;
      flex: 1;
    }

    .status {
      font-size: 7px;
      color: var(--text-muted);
      min-width: 90px;
      text-align: right;
    }

    .status.error {
      color: #f97373;
    }

    .footer {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      font-size: 7px;
      color: var(--text-muted);
    }

    @media (max-width: 700px) {
      .app {
        margin: 10px;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="crt"></div>

  <div class="app">
    <div class="header">
      <div class="title">TAMACARE</div>
      <div class="subtitle">RETRO HEALTH PET · LOG IRL HABITS</div>
    </div>

    <div class="grid">
      <!-- PET / STATS -->
      <div class="card">
        <div class="pet-shell">
          <div class="pet-screen">
            <img
            class="pet-chicken"
            id="pet-avatar"
            src="{{ url_for('static', filename='sprites/idle_heart_1.gif') }}"
            alt="TamaCare pet"
            />

            <!-- Speech bubble -->
            <div class="pet-bubble">
              <span id="pet-bubble-text">I feel okay.</span>
            </div>

            <div class="pet-status-text" id="pet-status-text">
              HEALTH: OK
            </div>
          </div>

          <div class="pet-caption" id="pet-caption">
            I eat your healthy choices. Please feed responsibly.
          </div>

          <div class="stats">
            <div class="stat-row">
              <span>HABITS TODAY</span>
              <span id="habits-today">0</span>
            </div>
            <div class="stat-row">
              <span>ENERGY</span>
              <span id="energy-label">5 / 10</span>
            </div>
            <div class="bar-bg">
              <div id="energy-bar" class="bar-fill bar-energy"></div>
            </div>
            <div class="stat-row" style="margin-top:4px;">
              <span>MOOD</span>
              <span id="mood-label">0.60</span>
            </div>
            <div class="bar-bg">
              <div id="mood-bar" class="bar-fill bar-mood"></div>
            </div>
          </div>

          <!-- NEW: Health snapshot panel -->
          <div class="health-panel" id="health-panel">
            <div class="health-title">LATEST HEALTH DATA</div>
            <div class="health-row">
              <span>DATE</span>
              <span id="hs-date">–</span>
            </div>
            <div class="health-row">
              <span>SLEEP (h)</span>
              <span id="hs-sleep">–</span>
            </div>
            <div class="health-row">
              <span>STEPS</span>
              <span id="hs-steps">–</span>
            </div>
            <div class="health-row">
              <span>EXERCISE (min)</span>
              <span id="hs-exercise">–</span>
            </div>
            <div class="health-row">
              <span>HRV (ms)</span>
              <span id="hs-hrv">–</span>
            </div>
            <div class="health-row">
              <span>AVG HR</span>
              <span id="hs-avg-hr">–</span>
            </div>
            <div class="health-small" id="hs-note">
              Press LOAD CSV to sync.
            </div>
            <button id="sync-health-btn" class="health-sync-btn">
              LOAD CSV
            </button>
          </div>
        </div>
      </div>

      <!-- CHAT -->
      <div class="card">
        <div id="chat-log" class="chat-log">
          <div class="msg msg-pet">
            ⌛ HEY. I’M YOUR HEALTH PET. TELL ME WHAT YOU DID FOR YOUR BODY OR BRAIN TODAY.
          </div>
        </div>

        <div class="chat-input-row">
          <textarea
            id="chat-input"
            placeholder="ex: WALKED 20 MIN AFTER LUNCH AND DRANK WATER."
          ></textarea>
          <div class="buttons-row">
            <button id="send-btn" class="btn btn-send">
              TALK
            </button>
            <button id="habit-btn" class="btn btn-habit">
              TRACK HABIT
            </button>
            <div id="status" class="status">READY</div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <span>LOOKS 8-BIT · THINKS 2025</span>
      <span>DATA + AI + HEALTHKIT READY</span>
    </div>
  </div>

  <script>
    const petBubbleText = document.getElementById("pet-bubble-text");
    const chatLog = document.getElementById("chat-log");
    const chatInput = document.getElementById("chat-input");
    const sendBtn = document.getElementById("send-btn");
    const habitBtn = document.getElementById("habit-btn");
    const statusEl = document.getElementById("status");
    const energyLabel = document.getElementById("energy-label");
    const energyBar = document.getElementById("energy-bar");
    const moodLabel = document.getElementById("mood-label");
    const moodBar = document.getElementById("mood-bar");
    const habitsTodayEl = document.getElementById("habits-today");
    const petCaption = document.getElementById("pet-caption");
    const petStatusText = document.getElementById("pet-status-text");
    const petAvatar = document.getElementById("pet-avatar");
    const syncHealthBtn = document.getElementById("sync-health-btn");

    // Health snapshot elements
    const hsDate = document.getElementById("hs-date");
    const hsSleep = document.getElementById("hs-sleep");
    const hsSteps = document.getElementById("hs-steps");
    const hsExercise = document.getElementById("hs-exercise");
    const hsHrv = document.getElementById("hs-hrv");
    const hsAvgHr = document.getElementById("hs-avg-hr");
    const hsNote = document.getElementById("hs-note");

    function appendMessage(role, text) {
      const div = document.createElement("div");
      div.classList.add("msg");
      if (role === "user") div.classList.add("msg-user");
      else div.classList.add("msg-pet");
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function getStateBubbleText(energy, mood, habitsToday) {
      if (energy <= 2) {
        return "I’m exhausted...";
      }
      if (mood <= 0.3) {
        return "Not feeling great today.";
      }
      if (mood >= 0.8 && habitsToday > 0) {
        return "I’m thriving today!";
      }
      if (habitsToday === 0) {
        return "Feed me some healthy choices.";
      }
      if (energy >= 7) {
        return "I’ve got plenty of energy.";
      }
      return "I feel okay, let’s keep going.";
    }

    function updateSpriteMood(energy, mood) {
    // Base path for your GIFs
    // These paths are relative to Flask's /static route

    if (energy <= 0.3) {
        petStatusText.textContent = "HEALTH: CRITICAL";
        petAvatar.src = "/static/sprites/dead-2.gif"

        setTimeout(() => {
            petAvatar.src = "/static/sprites/dead.gif";
        }, 1600);
        return;
    }

    if (energy <= 4) {
        petStatusText.textContent = "HEALTH: LOW";

        // play transition FIRST
        petAvatar.src = "/static/sprites/sad-heart-2.gif";

        // after it finishes, show the looping sad animation
        setTimeout(() => {
            petAvatar.src = "/static/sprites/sad_loop_heart_2.gif";
        }, 600); 
        return;
    }

    if (energy >= 9) {
        petStatusText.textContent = "HEALTH: GREAT";
        petAvatar.src = "/static/sprites/heart-hype2.gif"; // extra-bouncy animation
        return;
    }

    if (energy >= 7) {
        petStatusText.textContent = "HEALTH: GOOD";
        petAvatar.src = "/static/sprites/happy-heart.gif";
        return;
    }

    petStatusText.textContent = "HEALTH: OK";
    petAvatar.src = "/static/sprites/idle_heart_1.gif";
    }

    function updateHealthPanel(snapshot) {
      if (!snapshot) return;
      hsDate.textContent = snapshot.date || "—";
      hsSleep.textContent = snapshot.sleep_hours ?? "—";
      hsSteps.textContent = snapshot.steps ?? "—";
      hsExercise.textContent = snapshot.exercise_min ?? "—";
      hsHrv.textContent = snapshot.hrv_ms ?? "—";
      hsAvgHr.textContent = snapshot.avg_hr ?? "—";
      hsNote.textContent = "CSV synced into TamaCare.";
    }

    function updateStats(stats) {
      if (!stats) return;
      const energy = stats.energy ?? 5;
      const mood = stats.mood ?? 0.6;
      const habitsToday = stats.habits_today ?? 0;

      energyLabel.textContent = `${Math.round(energy)} / 10`;
      energyBar.style.width = `${(energy / 10) * 100}%`;

      moodLabel.textContent = mood.toFixed(2);
      moodBar.style.width = `${mood * 100}%`;

      habitsTodayEl.textContent = habitsToday;

      if (energy <= 3) {
        petCaption.textContent = "WE’RE BOTH LOW BATTERY. MAYBE REST OR WATER?";
      } else if (mood >= 0.8) {
        petCaption.textContent = "THIS RUN LOOKS STRONG. HIGH SCORE VIBES.";
      } else {
        petCaption.textContent = "SMALL HEALTH MOVES KEEP ME ALIVE.";
      }

      updateSpriteMood(energy, mood);

      if (stats.state_bubble) {
        petBubbleText.textContent = stats.state_bubble;
      } else {
        petBubbleText.textContent = getStateBubbleText(energy, mood, habitsToday);
      }

      const streakActive = stats.streak_active ?? false;
      const streakJustHit = stats.streak_just_hit ?? false;

      if (streakJustHit) {
        petAvatar.classList.add("streak");
        // remove the class after the animation so it can retrigger later
        setTimeout(() => {
          petAvatar.classList.remove("streak");
        }, 1000);
      }
    }

    async function sendTo(endpoint) {
      const text = chatInput.value.trim();
      if (!text) {
        statusEl.textContent = "TYPE SOMETHING";
        statusEl.classList.add("error");
        return;
      }
      statusEl.textContent = "THINKING…";
      statusEl.classList.remove("error");

      appendMessage("user", text);

      try {
        const res = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });

        if (!res.ok) {
          statusEl.textContent = "SERVER ERROR";
          statusEl.classList.add("error");
          return;
        }

        const data = await res.json();
        appendMessage("pet", data.pet_reply || "[NO REPLY]");
        updateStats(data.stats);
        statusEl.textContent = endpoint === "/habit" ? "HABIT LOGGED" : "REPLIED";

        if (endpoint === "/habit") {
          chatInput.value = "";
        }
      } catch (e) {
        console.error(e);
        statusEl.textContent = "NETWORK RIP";
        statusEl.classList.add("error");
      }
    }

    async function syncHealthFromCsv() {
      statusEl.textContent = "LOADING CSV…";
      statusEl.classList.remove("error");
      try {
        const res = await fetch("/load_health", {
          method: "POST"
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          statusEl.textContent = err.error || "CSV ERROR";
          statusEl.classList.add("error");
          return;
        }

        const data = await res.json();
        if (data.message) {
          appendMessage("pet", data.message);
        }
        updateStats(data.stats);
        updateHealthPanel(data.health_snapshot);
        statusEl.textContent = "CSV LOADED";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "CSV LOAD FAILED";
        statusEl.classList.add("error");
      }
    }

    sendBtn.addEventListener("click", () => sendTo("/chat"));
    habitBtn.addEventListener("click", () => sendTo("/habit"));
    syncHealthBtn.addEventListener("click", syncHealthFromCsv);

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendTo("/chat");
      }
    });
  </script>
</body>
</html>
